package com.github.admin.filter;

import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;

import org.apache.commons.lang.StringUtils;
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.session.Session;
import org.apache.shiro.subject.Subject;
import org.apache.shiro.web.servlet.AdviceFilter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.alibaba.fastjson.JSON;
import com.github.admin.common.constants.Constants;
import com.github.admin.common.vo.ResultVo;
import com.github.admin.handle.ExceptionHandle;

//@Order(1)
//@WebFilter(filterName = "loginFilter", urlPatterns = "/manage/**")
public class LoginFilter extends AdviceFilter{

	private final static Logger logger = LoggerFactory.getLogger(ExceptionHandle.class);
	private static final String URI = "/manage/index";
	
	protected boolean preHandle(ServletRequest request, ServletResponse response) throws Exception {
		logger.info("...............shiro filter........");
		HttpServletRequest httpServletRequest = (HttpServletRequest)request;
		String uri = httpServletRequest.getRequestURI();
		if(uri.indexOf(URI) > 0) {
			return true;
		}
		logger.info("请求uri = 【{}】",uri);
		if(SecurityUtils.getSubject() != null) {
			Subject subject = SecurityUtils.getSubject();
	        Session session = subject.getSession();
	        String sessionId = session.getId().toString();
	        String shiroSessionKey = Constants.ADMIN_SERVER_SESSION + sessionId;
	        logger.info("shiro sessionId = 【{}】,shiroSessionKey = 【{}】",sessionId,shiroSessionKey);
	        if(session.getAttribute(shiroSessionKey) != null) {
	        	String userName = (String)session.getAttribute(shiroSessionKey);
	        	logger.info("当前用户userName = 【{}】",userName);
	        	if(StringUtils.isBlank(userName)) {
	        		logger.info("当前用户不存在...........");
	    			ResultVo result = new ResultVo();
	    			result.setCode("10110");
	    			result.setMsg("登录超时!");
	    			result.setData("");
	    			result.setSuccess(false);
	    			response.setCharacterEncoding("utf-8");
	    			response.setContentType("application/json; charset=utf-8");
	    			response.getWriter().write(JSON.toJSONString(result));
	    			return false;
	        	}
	        }else{
	        	logger.info("不存在...........");
    			ResultVo result = new ResultVo();
    			result.setCode("10110");
    			result.setMsg("登录超时!");
    			result.setData("");
    			result.setSuccess(false);
//    			byte[] bytes = JSON.toJSONBytes(result, features);
    			response.setCharacterEncoding("utf-8");
    			response.setContentType("application/json; charset=utf-8");
    			response.getWriter().write(JSON.toJSONString(result));
    			return false;
	        }
		}
        return true;
    }

	public static void main(String args[]) {
		String url = "http://localhost:9001/manage/index";
		if(url.indexOf("/manage/index") > 0) {
			System.out.println("-----");
		}
	}
}
