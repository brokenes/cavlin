package com.github.admin.handle;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.shiro.authz.AuthorizationException;
import org.apache.shiro.authz.UnauthorizedException;
import org.apache.shiro.session.InvalidSessionException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.servlet.ModelAndView;

@ControllerAdvice
public class GlobalExceptionHandler{

	private final static Logger LOGGER = LoggerFactory.getLogger(GlobalExceptionHandler.class);
	
	@ExceptionHandler
	public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler,Exception exception) {
		LOGGER.error("Base统一异常处理：", exception);
		request.setAttribute("ex", exception);
		ModelAndView mv = new ModelAndView();
		if (null != request.getHeader("X-Requested-With") && "XMLHttpRequest".equalsIgnoreCase(request.getHeader("X-Requested-With"))) {
			request.setAttribute("requestHeader", "ajax");
		}
		// shiro没有权限异常
		Object e = request.getAttribute("ex");
		if (exception instanceof UnauthorizedException) {
			mv.setViewName("403");
			return mv;
		}
		// shiro会话已过期异常
		if (exception instanceof InvalidSessionException) {
			mv.setViewName("403");
			return mv;
		}
		if (exception instanceof AuthorizationException){
//			return new AdminModel(MsgCode.SYSTEM_EXCEPTION,"没有权限");
			mv.setViewName("403");
			return mv;
		}
		mv.setViewName("error");
		return mv;
	}

}
