package com.github.admin.interceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.lang3.StringUtils;
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.session.Session;
import org.apache.shiro.subject.Subject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import com.github.admin.common.constants.Constants;
import com.github.admin.utils.RedisUtils;


@Component
public class SessionTimeOutInterceptor extends HandlerInterceptorAdapter{

	private static Logger logger = LoggerFactory.getLogger(SessionTimeOutInterceptor.class);
	
	@Autowired
	private RedisUtils redisUtils;
	
	
	public boolean preHandle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o) throws Exception {
//        SysUser loginUser = (SysUser)httpServletRequest.getSession().getAttribute("loginUser");
        
		if(httpServletRequest.getSession() == null) {
			httpServletResponse.sendRedirect("/login");
            return false;
		}
		HttpSession session = httpServletRequest.getSession();
        String sessionId = session.getId();
        if(SecurityUtils.getSubject() == null) {
        	httpServletResponse.sendRedirect("/login");
            return false;
        }
        Subject subject = SecurityUtils.getSubject();
        if(subject.getSession() == null) {
        	httpServletResponse.sendRedirect("/login");
            return false;
        }
        Session shiroSession = subject.getSession();
        String attributeMsg = Constants.ADMIN_CURRENT_USER + sessionId;
        Object sessionObj = shiroSession.getAttribute(attributeMsg);
        if(sessionObj == null) {
        	httpServletResponse.sendRedirect("/login");
            return false;
        }
        String currentUserName = (String)sessionObj;
        logger.info("用户session超时拦截器当前currentName = 【{}】",currentUserName);
        
        String userJson = redisUtils.get(Constants.ADMIN_CURRENT_USER + currentUserName);
        logger.info("用户session超时拦截器当前userJson = 【{}】",userJson);
        
       // String requestURI = httpServletRequest.getRequestURI();
      //  System.err.println(requestURI);
        if(StringUtils.isEmpty(userJson)){
            httpServletResponse.sendRedirect("/login");
            return false;
        }
        return true;
    }

}
